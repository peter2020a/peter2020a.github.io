<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>OpenResty(Nginx+Lua)测试用例 | 流浪地球</title>
    <meta name="generator" content="VuePress 1.9.7">
    <link rel="icon" href="/logo.ico">
    <meta name="description" content="纵然出走时未曾想要流浪半生，归来时早已发现少年不再">
    
    <link rel="preload" href="/assets/css/0.styles.7b36eabc.css" as="style"><link rel="preload" href="/assets/js/app.2cd84a3f.js" as="script"><link rel="preload" href="/assets/js/2.63c13255.js" as="script"><link rel="preload" href="/assets/js/40.b516ee81.js" as="script"><link rel="prefetch" href="/assets/js/10.79ce38a9.js"><link rel="prefetch" href="/assets/js/11.b1d01830.js"><link rel="prefetch" href="/assets/js/12.8736c32f.js"><link rel="prefetch" href="/assets/js/13.ebee3709.js"><link rel="prefetch" href="/assets/js/14.2b0d4a27.js"><link rel="prefetch" href="/assets/js/15.e1d296a3.js"><link rel="prefetch" href="/assets/js/16.380d3c5e.js"><link rel="prefetch" href="/assets/js/17.746ecd1f.js"><link rel="prefetch" href="/assets/js/18.753f8f5a.js"><link rel="prefetch" href="/assets/js/19.9e16d87a.js"><link rel="prefetch" href="/assets/js/20.54b076df.js"><link rel="prefetch" href="/assets/js/21.11dd81d7.js"><link rel="prefetch" href="/assets/js/22.29cdb2fb.js"><link rel="prefetch" href="/assets/js/23.fd2fe5c2.js"><link rel="prefetch" href="/assets/js/24.ca7d6a70.js"><link rel="prefetch" href="/assets/js/25.0564d66c.js"><link rel="prefetch" href="/assets/js/26.ad480a02.js"><link rel="prefetch" href="/assets/js/27.4c43d411.js"><link rel="prefetch" href="/assets/js/28.e66385b0.js"><link rel="prefetch" href="/assets/js/29.ae4baeca.js"><link rel="prefetch" href="/assets/js/3.55d44e04.js"><link rel="prefetch" href="/assets/js/30.ba670f02.js"><link rel="prefetch" href="/assets/js/31.f3f42409.js"><link rel="prefetch" href="/assets/js/32.5d600afc.js"><link rel="prefetch" href="/assets/js/33.40a2a336.js"><link rel="prefetch" href="/assets/js/34.2a621ea3.js"><link rel="prefetch" href="/assets/js/35.56b8ae56.js"><link rel="prefetch" href="/assets/js/36.9e35ae04.js"><link rel="prefetch" href="/assets/js/37.78bb6a4a.js"><link rel="prefetch" href="/assets/js/38.4955006a.js"><link rel="prefetch" href="/assets/js/39.9ae6e79e.js"><link rel="prefetch" href="/assets/js/4.13c31685.js"><link rel="prefetch" href="/assets/js/41.6d6a113f.js"><link rel="prefetch" href="/assets/js/42.3b5d7847.js"><link rel="prefetch" href="/assets/js/43.41821ddc.js"><link rel="prefetch" href="/assets/js/44.bb04bcbc.js"><link rel="prefetch" href="/assets/js/45.46e8e459.js"><link rel="prefetch" href="/assets/js/46.9de03981.js"><link rel="prefetch" href="/assets/js/47.aea7ab35.js"><link rel="prefetch" href="/assets/js/48.adb143bb.js"><link rel="prefetch" href="/assets/js/49.fd27f7d0.js"><link rel="prefetch" href="/assets/js/5.69487806.js"><link rel="prefetch" href="/assets/js/6.8d81f0ec.js"><link rel="prefetch" href="/assets/js/7.3bd43f9a.js"><link rel="prefetch" href="/assets/js/8.f6a07905.js"><link rel="prefetch" href="/assets/js/9.36b4852e.js">
    <link rel="stylesheet" href="/assets/css/0.styles.7b36eabc.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">流浪地球</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/java_1.html" class="nav-link">
  jobHandler调度管理
</a></li><li class="dropdown-item"><!----> <a href="/Java/java_2.html" class="nav-link">
  jProtobuf尝鲜
</a></li><li class="dropdown-item"><!----> <a href="/SpringBoot/springboot_1.html" class="nav-link">
  使用Docker部署Spring Boot
</a></li><li class="dropdown-item"><!----> <a href="/SpringCloud/springcloud_1.html" class="nav-link">
  springcloud(一)：初识Spring Cloud
</a></li><li class="dropdown-item"><!----> <a href="/SpringCloud/springcloud_2.html" class="nav-link">
  springcloud(二)：注册中心Eureka
</a></li><li class="dropdown-item"><!----> <a href="/Java/java_3.html" class="nav-link">
  java8 toMap问题(key重复如何解决)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BigData/bigdata_1.html" class="nav-link">
  使用Docker搭建Hadoop集群(伪分布式与完全分布式)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="区块链" class="dropdown-title"><span class="title">区块链</span> <span class="arrow down"></span></button> <button type="button" aria-label="区块链" class="mobile-dropdown-title"><span class="title">区块链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlockChain/block_1.html" class="nav-link">
  1、Java实现简单区块链
</a></li><li class="dropdown-item"><!----> <a href="/BlockChain/block_2.html" class="nav-link">
  2、Java实现可交易钱包
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Go" class="dropdown-title"><span class="title">Go</span> <span class="arrow down"></span></button> <button type="button" aria-label="Go" class="mobile-dropdown-title"><span class="title">Go</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Go/go_1.html" class="nav-link">
  go的基本命令详解
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_2.html" class="nav-link">
  gin框架使用案例
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_3.html" class="nav-link">
  gorm基本使用
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_4.html" class="nav-link">
  Golang操作Redis
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_5.html" class="nav-link">
  golang实现tcp通信
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_6.html" class="nav-link">
  Golang使用Protobuf 
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><span class="title">Linux</span> <span class="arrow down"></span></button> <button type="button" aria-label="Linux" class="mobile-dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Linux/linux_1.html" class="nav-link">
  虚拟机3种网络模式
</a></li><li class="dropdown-item"><!----> <a href="/Linux/linux_2.html" class="nav-link">
  linux常用命令总结
</a></li><li class="dropdown-item"><!----> <a href="/Linux/linux_3.html" class="nav-link">
  centos7部署FastDFS
</a></li><li class="dropdown-item"><!----> <a href="/Linux/linux_4.html" class="nav-link">
  centos7中根据文件大小排序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Docker" class="dropdown-title"><span class="title">Docker</span> <span class="arrow down"></span></button> <button type="button" aria-label="Docker" class="mobile-dropdown-title"><span class="title">Docker</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Docker/docker_1.html" class="nav-link">
  Docker(一)：Docker入门教程
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_2.html" class="nav-link">
  Docker(二)：Dockerfile使用介绍
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_3.html" class="nav-link">
  Docker(三)：Dockerfile命令详解
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_4.html" class="nav-link">
  Docker(四)：Docker三剑客之Docker Compose
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_5.html" class="nav-link">
  Docker(五)：Docker三剑客之Docker Machine
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_6.html" class="nav-link">
  Docker(六)：Docker三剑客之Docker Swarm
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_7.html" class="nav-link">
  Docker安装MariaDB
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_9.html" class="nav-link">
  Docker安装Mysql8
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_8.html" class="nav-link">
  Docker安装Redis
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_10.html" class="nav-link">
  Docker安装Nacos
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="K8s" class="dropdown-title"><span class="title">K8s</span> <span class="arrow down"></span></button> <button type="button" aria-label="K8s" class="mobile-dropdown-title"><span class="title">K8s</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/K8s/k8s_1.html" class="nav-link">
  VirtualBox + centos7部署k8s
</a></li><li class="dropdown-item"><!----> <a href="/K8s/k8s_2.html" class="nav-link">
  kubectl常用命令
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Nginx" class="dropdown-title"><span class="title">Nginx</span> <span class="arrow down"></span></button> <button type="button" aria-label="Nginx" class="mobile-dropdown-title"><span class="title">Nginx</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/OpenResty/nginx.html" class="nav-link">
  Nginx 配置详解
</a></li><li class="dropdown-item"><!----> <a href="/OpenResty/nginx_2.html" class="nav-link">
  Nginx 常用命令
</a></li><li class="dropdown-item"><!----> <a href="/OpenResty/openresty_1.html" class="nav-link">
  OpenResty 使用介绍
</a></li><li class="dropdown-item"><!----> <a href="/OpenResty/openresty_2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  OpenResty(Nginx+Lua)测试用例
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Jenkins" class="dropdown-title"><span class="title">Jenkins</span> <span class="arrow down"></span></button> <button type="button" aria-label="Jenkins" class="mobile-dropdown-title"><span class="title">Jenkins</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Jenkins/jenkins_1.html" class="nav-link">
  快速安装Jenkins完美教程
</a></li><li class="dropdown-item"><!----> <a href="/Jenkins/jenkins_2.html" class="nav-link">
  Docker jenkins配置NPM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Other/2019.1.2.html" class="nav-link">
  Vuepress搭建静态博客
</a></li><li class="dropdown-item"><!----> <a href="/Other/markdown.html" class="nav-link">
  Markdown基本语法
</a></li></ul></div></div><div class="nav-item"><a href="/Readme/index.html" class="nav-link">
  关于我
</a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java" class="dropdown-title"><span class="title">Java</span> <span class="arrow down"></span></button> <button type="button" aria-label="Java" class="mobile-dropdown-title"><span class="title">Java</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Java/java_1.html" class="nav-link">
  jobHandler调度管理
</a></li><li class="dropdown-item"><!----> <a href="/Java/java_2.html" class="nav-link">
  jProtobuf尝鲜
</a></li><li class="dropdown-item"><!----> <a href="/SpringBoot/springboot_1.html" class="nav-link">
  使用Docker部署Spring Boot
</a></li><li class="dropdown-item"><!----> <a href="/SpringCloud/springcloud_1.html" class="nav-link">
  springcloud(一)：初识Spring Cloud
</a></li><li class="dropdown-item"><!----> <a href="/SpringCloud/springcloud_2.html" class="nav-link">
  springcloud(二)：注册中心Eureka
</a></li><li class="dropdown-item"><!----> <a href="/Java/java_3.html" class="nav-link">
  java8 toMap问题(key重复如何解决)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="大数据" class="dropdown-title"><span class="title">大数据</span> <span class="arrow down"></span></button> <button type="button" aria-label="大数据" class="mobile-dropdown-title"><span class="title">大数据</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BigData/bigdata_1.html" class="nav-link">
  使用Docker搭建Hadoop集群(伪分布式与完全分布式)
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="区块链" class="dropdown-title"><span class="title">区块链</span> <span class="arrow down"></span></button> <button type="button" aria-label="区块链" class="mobile-dropdown-title"><span class="title">区块链</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/BlockChain/block_1.html" class="nav-link">
  1、Java实现简单区块链
</a></li><li class="dropdown-item"><!----> <a href="/BlockChain/block_2.html" class="nav-link">
  2、Java实现可交易钱包
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Go" class="dropdown-title"><span class="title">Go</span> <span class="arrow down"></span></button> <button type="button" aria-label="Go" class="mobile-dropdown-title"><span class="title">Go</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Go/go_1.html" class="nav-link">
  go的基本命令详解
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_2.html" class="nav-link">
  gin框架使用案例
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_3.html" class="nav-link">
  gorm基本使用
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_4.html" class="nav-link">
  Golang操作Redis
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_5.html" class="nav-link">
  golang实现tcp通信
</a></li><li class="dropdown-item"><!----> <a href="/Go/go_6.html" class="nav-link">
  Golang使用Protobuf 
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Linux" class="dropdown-title"><span class="title">Linux</span> <span class="arrow down"></span></button> <button type="button" aria-label="Linux" class="mobile-dropdown-title"><span class="title">Linux</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Linux/linux_1.html" class="nav-link">
  虚拟机3种网络模式
</a></li><li class="dropdown-item"><!----> <a href="/Linux/linux_2.html" class="nav-link">
  linux常用命令总结
</a></li><li class="dropdown-item"><!----> <a href="/Linux/linux_3.html" class="nav-link">
  centos7部署FastDFS
</a></li><li class="dropdown-item"><!----> <a href="/Linux/linux_4.html" class="nav-link">
  centos7中根据文件大小排序
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Docker" class="dropdown-title"><span class="title">Docker</span> <span class="arrow down"></span></button> <button type="button" aria-label="Docker" class="mobile-dropdown-title"><span class="title">Docker</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Docker/docker_1.html" class="nav-link">
  Docker(一)：Docker入门教程
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_2.html" class="nav-link">
  Docker(二)：Dockerfile使用介绍
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_3.html" class="nav-link">
  Docker(三)：Dockerfile命令详解
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_4.html" class="nav-link">
  Docker(四)：Docker三剑客之Docker Compose
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_5.html" class="nav-link">
  Docker(五)：Docker三剑客之Docker Machine
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_6.html" class="nav-link">
  Docker(六)：Docker三剑客之Docker Swarm
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_7.html" class="nav-link">
  Docker安装MariaDB
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_9.html" class="nav-link">
  Docker安装Mysql8
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_8.html" class="nav-link">
  Docker安装Redis
</a></li><li class="dropdown-item"><!----> <a href="/Docker/docker_10.html" class="nav-link">
  Docker安装Nacos
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="K8s" class="dropdown-title"><span class="title">K8s</span> <span class="arrow down"></span></button> <button type="button" aria-label="K8s" class="mobile-dropdown-title"><span class="title">K8s</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/K8s/k8s_1.html" class="nav-link">
  VirtualBox + centos7部署k8s
</a></li><li class="dropdown-item"><!----> <a href="/K8s/k8s_2.html" class="nav-link">
  kubectl常用命令
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Nginx" class="dropdown-title"><span class="title">Nginx</span> <span class="arrow down"></span></button> <button type="button" aria-label="Nginx" class="mobile-dropdown-title"><span class="title">Nginx</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/OpenResty/nginx.html" class="nav-link">
  Nginx 配置详解
</a></li><li class="dropdown-item"><!----> <a href="/OpenResty/nginx_2.html" class="nav-link">
  Nginx 常用命令
</a></li><li class="dropdown-item"><!----> <a href="/OpenResty/openresty_1.html" class="nav-link">
  OpenResty 使用介绍
</a></li><li class="dropdown-item"><!----> <a href="/OpenResty/openresty_2.html" aria-current="page" class="nav-link router-link-exact-active router-link-active">
  OpenResty(Nginx+Lua)测试用例
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Jenkins" class="dropdown-title"><span class="title">Jenkins</span> <span class="arrow down"></span></button> <button type="button" aria-label="Jenkins" class="mobile-dropdown-title"><span class="title">Jenkins</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Jenkins/jenkins_1.html" class="nav-link">
  快速安装Jenkins完美教程
</a></li><li class="dropdown-item"><!----> <a href="/Jenkins/jenkins_2.html" class="nav-link">
  Docker jenkins配置NPM
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="其它" class="dropdown-title"><span class="title">其它</span> <span class="arrow down"></span></button> <button type="button" aria-label="其它" class="mobile-dropdown-title"><span class="title">其它</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/Other/2019.1.2.html" class="nav-link">
  Vuepress搭建静态博客
</a></li><li class="dropdown-item"><!----> <a href="/Other/markdown.html" class="nav-link">
  Markdown基本语法
</a></li></ul></div></div><div class="nav-item"><a href="/Readme/index.html" class="nav-link">
  关于我
</a></div> <!----></nav>  <!----> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="openresty-nginx-lua-测试用例"><a href="#openresty-nginx-lua-测试用例" class="header-anchor">#</a> OpenResty(Nginx+Lua)测试用例</h1> <h2 id="一丶nginx-lua-api"><a href="#一丶nginx-lua-api" class="header-anchor">#</a> 一丶Nginx Lua API</h2> <p>和一般的Web Server类似，我们需要接收请求、处理并输出响应。</p> <div class="language- extra-class"><pre class="language-text"><code>对于请求我们需要获取如请求参数、请求头、Body体等信息；

对于处理就是调用相应的Lua代码即可；

对于输出响应需要进行响应状态码、响应头和响应内容体的输出。
</code></pre></div><p>因此我们从如上几个点出发即可。</p> <h3 id="_1丶接收请求"><a href="#_1丶接收请求" class="header-anchor">#</a> 1丶接收请求</h3> <h4 id="_1-example-conf配置文件"><a href="#_1-example-conf配置文件" class="header-anchor">#</a> （1）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location ~ /lua_request/(\d+)/(\d+) {  
    #设置nginx变量  
    set $a $1;   
    set $b $host;  
    default_type &quot;text/html&quot;;  
    #nginx内容处理  
    content_by_lua_file /home/www/lua/test_request.lua;  
    #内容体处理完成后调用  
    echo_after_body &quot;ngx.var.b $b&quot;;  
} 
</code></pre></div><h4 id="_2-test-request-lua"><a href="#_2-test-request-lua" class="header-anchor">#</a> （2）test_request.lua</h4> <p>针对下面的lua脚本并不是单纯的lua脚本，而是和Nginx集成之后的特有的一些语法，即下面的lua脚本用lua的IDE是没办法直接运行的，但是直接可以用lua的IDE运行的lua脚本是可以在Nginx中集成的lua环境中运行的。</p> <p>如下方法处理一般的请求基本够用了。另外在读取post内容体时根据实际情况设置client_body_buffer_size和client_max_body_size来保证内容在内存而不是在文件中。</p> <div class="language- extra-class"><pre class="language-text"><code>ngx.var ：nginx变量，如果要赋值如ngx.var.b = 2，此变量必须提前声明；另外对于nginx
location中使用正则捕获的捕获组可以使用ngx.var[捕获组数字]获取；

ngx.req.get_headers：获取请求头，默认只获取前100，如果想要获取所以可以调用

ngx.req.get_headers(0)：获取带中划线的请求头时请使用如headers.user_agent这种方式；如果一个请求头有多个值，则返回的是table；

ngx.req.get_uri_args：获取url请求参数，其用法和get_headers类似；

ngx.req.get_post_args：获取post请求内容体，其用法和get_headers类似，但是必须提前调用

ngx.req.read_body()：来读取body体（也可以选择在nginx配置文件使用lua_need_request_body
on;开启读取body体，但是官方不推荐）；

ngx.req.raw_header：未解析的请求头字符串；

ngx.req.get_body_data：为解析的请求body体内容字符串。
</code></pre></div><p>如上方法处理一般的请求基本够用了。另外在读取post内容体时根据实际情况设置client_body_buffer_size和client_max_body_size来保证内容在内存而不是在文件中。下面给出一个上述方法示例：</p> <div class="language- extra-class"><pre class="language-text"><code>--nginx变量  
local var = ngx.var  
ngx.say(&quot;ngx.var.a : &quot;, var.a, &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;ngx.var.b : &quot;, var.b, &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;ngx.var[2] : &quot;, var[2], &quot;&lt;br/&gt;&quot;)  
ngx.var.b = 2;  

ngx.say(&quot;&lt;br/&gt;&quot;)  

--请求头  
local headers = ngx.req.get_headers()  
ngx.say(&quot;headers begin&quot;, &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;Host : &quot;, headers[&quot;Host&quot;], &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;user-agent : &quot;, headers[&quot;user-agent&quot;], &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;user-agent : &quot;, headers.user_agent, &quot;&lt;br/&gt;&quot;)  
for k,v in pairs(headers) do  
    if type(v) == &quot;table&quot; then  
        ngx.say(k, &quot; : &quot;, table.concat(v, &quot;,&quot;), &quot;&lt;br/&gt;&quot;)  
    else  
        ngx.say(k, &quot; : &quot;, v, &quot;&lt;br/&gt;&quot;)  
    end  
end  
ngx.say(&quot;headers end&quot;, &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;&lt;br/&gt;&quot;)  

--get请求uri参数  
ngx.say(&quot;uri args begin&quot;, &quot;&lt;br/&gt;&quot;)  
local uri_args = ngx.req.get_uri_args()  
for k, v in pairs(uri_args) do  
    if type(v) == &quot;table&quot; then  
        ngx.say(k, &quot; : &quot;, table.concat(v, &quot;, &quot;), &quot;&lt;br/&gt;&quot;)  
    else  
        ngx.say(k, &quot;: &quot;, v, &quot;&lt;br/&gt;&quot;)  
    end  
end  
ngx.say(&quot;uri args end&quot;, &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;&lt;br/&gt;&quot;)  

--post请求参数  
ngx.req.read_body()  
ngx.say(&quot;post args begin&quot;, &quot;&lt;br/&gt;&quot;)  
local post_args = ngx.req.get_post_args()  
for k, v in pairs(post_args) do  
    if type(v) == &quot;table&quot; then  
        ngx.say(k, &quot; : &quot;, table.concat(v, &quot;, &quot;), &quot;&lt;br/&gt;&quot;)  
    else  
        ngx.say(k, &quot;: &quot;, v, &quot;&lt;br/&gt;&quot;)  
    end  
end  
ngx.say(&quot;post args end&quot;, &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;&lt;br/&gt;&quot;)  

--请求的http协议版本  
ngx.say(&quot;ngx.req.http_version : &quot;, ngx.req.http_version(), &quot;&lt;br/&gt;&quot;)  
--请求方法  
ngx.say(&quot;ngx.req.get_method : &quot;, ngx.req.get_method(), &quot;&lt;br/&gt;&quot;)  
--原始的请求头内容  
ngx.say(&quot;ngx.req.raw_header : &quot;,  ngx.req.raw_header(), &quot;&lt;br/&gt;&quot;)  
--请求的body内容体  
ngx.say(&quot;ngx.req.get_body_data() : &quot;, ngx.req.get_body_data(), &quot;&lt;br/&gt;&quot;)  
ngx.say(&quot;&lt;br/&gt;&quot;)  
</code></pre></div><p>使用如下脚本测试</p> <div class="language- extra-class"><pre class="language-text"><code>wget --post-data 'a=1&amp;b=2' 'http://127.0.0.1/lua_request/1/2?a=3&amp;b=4' -O -  
</code></pre></div><h3 id="_2丶响应输出"><a href="#_2丶响应输出" class="header-anchor">#</a> 2丶响应输出</h3> <h4 id="_1-1-example-conf配置文件"><a href="#_1-1-example-conf配置文件" class="header-anchor">#</a> （1.1）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_response_1 {  
    default_type &quot;text/html&quot;;  
    content_by_lua_file /home/www/lua/test_response_1.lua;  
}  
</code></pre></div><h4 id="_1-2-test-response-1-lua"><a href="#_1-2-test-response-1-lua" class="header-anchor">#</a> （1.2）test_response_1.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>--写响应头  
ngx.header.a = &quot;1&quot;  
--多个响应头可以使用table  
ngx.header.b = {&quot;2&quot;, &quot;3&quot;}  
--输出响应  
ngx.say(&quot;a&quot;, &quot;b&quot;, &quot;&lt;br/&gt;&quot;)  
ngx.print(&quot;c&quot;, &quot;d&quot;, &quot;&lt;br/&gt;&quot;)  
--200状态码退出  
return ngx.exit(200)
</code></pre></div><p>ngx.header：输出响应头；</p> <p>ngx.print：输出响应内容体；</p> <p>ngx.say：通ngx.print，但是会最后输出一个换行符；</p> <p>ngx.exit：指定状态码退出。</p> <h4 id="_2-1-example-conf配置文件"><a href="#_2-1-example-conf配置文件" class="header-anchor">#</a> （2.1）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_response_2 {  
    default_type &quot;text/html&quot;;  
    content_by_lua_file /home/www/lua/test_response_2.lua;  
}  
</code></pre></div><h4 id="_2-2-test-response-2-lua"><a href="#_2-2-test-response-2-lua" class="header-anchor">#</a> （2.2）test_response_2.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>ngx.redirect(&quot;http://jd.com&quot;, 302)  
</code></pre></div><p>ngx.redirect：重定向；</p> <p>ngx.status=状态码，设置响应的状态码；ngx.resp.get_headers()获取设置的响应状态码；ngx.send_headers()发送响应状态码，当调用ngx.say/ngx.print时自动发送响应状态码；可以通过ngx.headers_sent=true判断是否发送了响应状态码。</p> <h3 id="_3丶其他api"><a href="#_3丶其他api" class="header-anchor">#</a> 3丶其他API</h3> <h4 id="_1、example-conf配置文件"><a href="#_1、example-conf配置文件" class="header-anchor">#</a> 1、example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_other {  
    default_type &quot;text/html&quot;;  
    content_by_lua_file /home/www/lua/test_other.lua;  
}  
</code></pre></div><h4 id="_2、test-other-lua"><a href="#_2、test-other-lua" class="header-anchor">#</a> 2、test_other.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>--未经解码的请求uri  
local request_uri = ngx.var.request_uri;  
ngx.say(&quot;request_uri : &quot;, request_uri, &quot;&lt;br/&gt;&quot;);  
--解码  
ngx.say(&quot;decode request_uri : &quot;, ngx.unescape_uri(request_uri), &quot;&lt;br/&gt;&quot;);  
--MD5  
ngx.say(&quot;ngx.md5 : &quot;, ngx.md5(&quot;123&quot;), &quot;&lt;br/&gt;&quot;)  
--http time  
ngx.say(&quot;ngx.http_time : &quot;, ngx.http_time(ngx.time()), &quot;&lt;br/&gt;&quot;)  
</code></pre></div><p>ngx.escape_uri/ngx.unescape_uri ： uri编码解码；</p> <p>ngx.encode_args/ngx.decode_args：参数编码解码；</p> <p>ngx.encode_base64/ngx.decode_base64：BASE64编码解码；</p> <p>ngx.re.match：nginx正则表达式匹配；</p> <h3 id="_4丶nginx全局内存"><a href="#_4丶nginx全局内存" class="header-anchor">#</a> 4丶Nginx全局内存</h3> <p>使用过如Java的朋友可能知道如Ehcache等这种进程内本地缓存，Nginx是一个Master进程多个Worker进程的工作方式，因此我们可能需要在多个Worker进程中共享数据，那么此时就可以使用ngx.shared.DICT来实现全局内存共享。</p> <h4 id="_1-首先在nginx-conf的http部分分配内存大小"><a href="#_1-首先在nginx-conf的http部分分配内存大小" class="header-anchor">#</a> （1）首先在nginx.conf的http部分分配内存大小</h4> <div class="language- extra-class"><pre class="language-text"><code>#共享全局变量，在所有worker间共享  
lua_shared_dict shared_data 1m; 
</code></pre></div><h4 id="_2-example-conf配置文件"><a href="#_2-example-conf配置文件" class="header-anchor">#</a> （2）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_shared_dict {  
    default_type &quot;text/html&quot;;  
    content_by_lua_file /home/www/lua/test_lua_shared_dict.lua;  
}  
</code></pre></div><h4 id="_3-test-lua-shared-dict-lua"><a href="#_3-test-lua-shared-dict-lua" class="header-anchor">#</a> （3）test_lua_shared_dict.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>--1、获取全局共享内存变量  
local shared_data = ngx.shared.shared_data  

--2、获取字典值  
local i = shared_data:get(&quot;i&quot;)  
if not i then  
    i = 1  
    --3、惰性赋值  
    shared_data:set(&quot;i&quot;, i)  
    ngx.say(&quot;lazy set i &quot;, i, &quot;&lt;br/&gt;&quot;)  
end  
--递增  
i = shared_data:incr(&quot;i&quot;, 1)  
ngx.say(&quot;i=&quot;, i, &quot;&lt;br/&gt;&quot;)  
</code></pre></div><p>到此基本的Nginx Lua API就学完了，对于请求处理和输出响应如上介绍的API完全够用了，更多API请参考官方文档：<a href="http://wiki.nginx.org/HttpLuaModule#ngx.shared.DICT" target="_blank">http://wiki.nginx.org/HttpLuaModule#ngx.shared.DICT</a></p> <h2 id="二丶nginx-lua模块指令"><a href="#二丶nginx-lua模块指令" class="header-anchor">#</a> 二丶Nginx Lua模块指令</h2> <p>Nginx共11个处理阶段，而相应的处理阶段是可以做插入式处理，即可插拔式架构；另外指令可以在http、server、server if、location、location if几个范围进行配置：</p> <table><thead><tr><th>指令</th> <th style="text-align:center;">所处处理阶段</th> <th style="text-align:center;">使用范围</th> <th>解释</th></tr></thead> <tbody><tr><td>init_by_lua init_by_lua_file</td> <td style="text-align:center;">loading-config</td> <td style="text-align:center;">http</td> <td>nginx Master进程加载配置时执行；通常用于初始化全局配置/预加载Lua模块</td></tr> <tr><td>init_worker_by_lua init_worker_by_lua_file</td> <td style="text-align:center;">starting-worker</td> <td style="text-align:center;">http</td> <td>每个Nginx Worker进程启动时调用的计时器，如果Master进程不允许则只会在init_by_lua之后调用；通常用于定时拉取配置/数据，或者后端服务的健康检查</td></tr> <tr><td>set_by_lua set_by_lua_file</td> <td style="text-align:center;">rewrite</td> <td style="text-align:center;">server,server if,location,location if</td> <td>设置nginx变量，可以实现复杂的赋值逻辑；此处是阻塞的，Lua代码要做到非常快；</td></tr> <tr><td>rewrite_by_lua rewrite_by_lua_file</td> <td style="text-align:center;">rewrite tail</td> <td style="text-align:center;">http,server,location,location if</td> <td>rrewrite阶段处理，可以实现复杂的转发/重定向逻辑；</td></tr> <tr><td>access_by_lua access_by_lua_file</td> <td style="text-align:center;">access tail</td> <td style="text-align:center;">http,server,location,location if</td> <td>请求访问阶段处理，用于访问控制</td></tr> <tr><td>content_by_lua content_by_lua_file</td> <td style="text-align:center;">content</td> <td style="text-align:center;">location，location if</td> <td>内容处理器，接收请求处理并输出响应</td></tr> <tr><td>header_filter_by_lua header_filter_by_lua_file</td> <td style="text-align:center;">output-header-filter</td> <td style="text-align:center;">http，server，location，location if</td> <td>设置header和cookie</td></tr> <tr><td>body_filter_by_lua body_filter_by_lua_file</td> <td style="text-align:center;">output-body-filter</td> <td style="text-align:center;">http，server，location，location if</td> <td>对响应数据进行过滤，比如截断、替换。</td></tr> <tr><td>log_by_lua log_by_lua_file</td> <td style="text-align:center;">log</td> <td style="text-align:center;">http，server，location，location if</td> <td>log阶段处理，比如记录访问量/统计平均响应时间</td></tr></tbody></table> <h3 id="_1、init-by-lua"><a href="#_1、init-by-lua" class="header-anchor">#</a> 1、init_by_lua</h3> <p>每次Nginx重新加载配置时执行，可以用它来完成一些耗时模块的加载，或者初始化一些全局配置；在Master进程创建Worker进程时，此指令中加载的全局变量会进行Copy-OnWrite，即会复制到所有全局变量到Worker进程。</p> <h4 id="_1-nginx-conf配置文件中的http部分添加如下代码"><a href="#_1-nginx-conf配置文件中的http部分添加如下代码" class="header-anchor">#</a> （1）nginx.conf配置文件中的http部分添加如下代码</h4> <div class="language- extra-class"><pre class="language-text"><code>#共享全局变量，在所有worker间共享  
lua_shared_dict shared_data 1m;  

init_by_lua_file /home/www/lua/init.lua; 
</code></pre></div><h4 id="_2-init-lua"><a href="#_2-init-lua" class="header-anchor">#</a> （2）init.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>--初始化耗时的模块  
local redis = require 'resty.redis'  
local cjson = require 'cjson'  

--全局变量，不推荐  
count = 1  

--共享全局内存  
local shared_data = ngx.shared.shared_data  
shared_data:set(&quot;count&quot;, 1)  
</code></pre></div><h4 id="_3-test-lua"><a href="#_3-test-lua" class="header-anchor">#</a> （3）test.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>count = count + 1  
ngx.say(&quot;global variable : &quot;, count)  
local shared_data = ngx.shared.shared_data  
ngx.say(&quot;, shared memory : &quot;, shared_data:get(&quot;count&quot;))  
shared_data:incr(&quot;count&quot;, 1)  
ngx.say(&quot;hello world&quot;)  
</code></pre></div><p><strong>另外注意一定在生产环境开启lua_code_cache，否则每个请求都会创建Lua VM实例。</strong></p> <h3 id="_2、init-worker-by-lua"><a href="#_2、init-worker-by-lua" class="header-anchor">#</a> 2、init_worker_by_lua</h3> <p>用于启动一些定时任务，比如心跳检查，定时拉取服务器配置等等；此处的任务是跟Worker进程数量有关系的，比如有2个Worker进程那么就会启动两个完全一样的定时任务。</p> <h4 id="_1-nginx-conf配置文件中的http部分添加如下代码-2"><a href="#_1-nginx-conf配置文件中的http部分添加如下代码-2" class="header-anchor">#</a> （1）nginx.conf配置文件中的http部分添加如下代码</h4> <div class="language- extra-class"><pre class="language-text"><code>init_worker_by_lua_file /home/www/lua/init_worker.lua;  
</code></pre></div><h4 id="_2-init-worker-lua"><a href="#_2-init-worker-lua" class="header-anchor">#</a> （2）init_worker.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>local count = 0  
local delayInSeconds = 3  
local heartbeatCheck = nil  

heartbeatCheck = function(args)  
   count = count + 1  
   ngx.log(ngx.ERR, &quot;do check &quot;, count)  

   local ok, err = ngx.timer.at(delayInSeconds, heartbeatCheck)  

   if not ok then  
      ngx.log(ngx.ERR, &quot;failed to startup heartbeart worker...&quot;, err)  
   end  
end  

heartbeatCheck() 
</code></pre></div><p>ngx.timer.at：延时调用相应的回调方法；ngx.timer.at(秒单位延时，回调函数，回调函数的参数列表)；可以将延时设置为0即得到一个立即执行的任务，任务不会在当前请求中执行不会阻塞当前请求，而是在一个轻量级线程中执行。</p> <p>另外根据实际情况设置如下指令</p> <div class="language- extra-class"><pre class="language-text"><code>lua_max_pending_timers 1024; #最大等待任务数

lua_max_running_timers 256; #最大同时运行任务数
</code></pre></div><h3 id="_3、set-by-lua"><a href="#_3、set-by-lua" class="header-anchor">#</a> 3、set_by_lua</h3> <p>设置nginx变量，我们用的set指令即使配合if指令也很难实现负责的赋值逻辑；</p> <h4 id="_1-1-、example-conf配置文件"><a href="#_1-1-、example-conf配置文件" class="header-anchor">#</a> （1.1）、example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_set_1 {  
    default_type &quot;text/html&quot;;  
    set_by_lua_file $num /usr/example/lua/test_set_1.lua;  
    echo $num;  
}  
</code></pre></div><p><strong>set_by_lua_file</strong>：语法set_by_lua_file $var lua_file arg1 arg2…; 在lua代码中可以实现所有复杂的逻辑，但是要执行速度很快，不要阻塞；</p> <h4 id="_1-2-test-set-1-lua"><a href="#_1-2-test-set-1-lua" class="header-anchor">#</a> （1.2）test_set_1.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>local uri_args = ngx.req.get_uri_args()  
local i = uri_args[&quot;i&quot;] or 0  
local j = uri_args[&quot;j&quot;] or 0  

return i + j 
</code></pre></div><p>得到请求参数进行相加然后返回。</p> <p>访问如http://192.168.1.2/lua_set_1?i=1&amp;j=10进行测试。 如果我们用纯set指令是无法实现的。</p> <p>再举个实际例子，我们实际工作时经常涉及到网站改版，有时候需要新老并存，或者切一部分流量到新版</p> <h4 id="_2-1-、首先在example-conf中使用map指令来映射host到指定nginx变量-方便我们测试"><a href="#_2-1-、首先在example-conf中使用map指令来映射host到指定nginx变量-方便我们测试" class="header-anchor">#</a> （2.1）、首先在example.conf中使用map指令来映射host到指定nginx变量，方便我们测试</h4> <div class="language- extra-class"><pre class="language-text"><code>############ 测试时使用的动态请求  
map $host $item_dynamic {  
    default                     &quot;0&quot;;  
    item2014.jd.com            &quot;1&quot;;  
}  
</code></pre></div><p>如绑定hosts</p> <div class="language- extra-class"><pre class="language-text"><code>192.168.1.2 item.jd.com;

192.168.1.2 item2014.jd.com;
</code></pre></div><p>此时我们想访问item2014.jd.com时访问新版，那么我们可以简单的使用如</p> <div class="language- extra-class"><pre class="language-text"><code>if ($item_dynamic = &quot;1&quot;) {  
   proxy_pass http://new;  
}  
proxy_pass http://old;  
</code></pre></div><p>但是我们想把商品编号为为8位(比如品类为图书的)没有改版完成，需要按照相应规则跳转到老版，但是其他的到新版；虽然使用if指令能实现，但是比较麻烦，基本需要这样</p> <div class="language- extra-class"><pre class="language-text"><code>set jump &quot;0&quot;;  
if($item_dynamic = &quot;1&quot;) {  
    set $jump &quot;1&quot;;  
}  
if(uri ~ &quot;^/6[0-9]{7}.html&quot;) {  
   set $jump &quot;${jump}2&quot;;  
}  
#非强制访问新版，且访问指定范围的商品  
if (jump == &quot;02&quot;) {  
   proxy_pass http://old;  
}  
proxy_pass http://new;  
</code></pre></div><p>以上规则还是比较简单的，如果涉及到更复杂的多重if/else或嵌套if/else实现起来就更痛苦了，可能需要到后端去做了；此时我们就可以借助lua了：</p> <div class="language- extra-class"><pre class="language-text"><code>set_by_lua $to_book '  
     local ngx_match = ngx.re.match  
     local var = ngx.var  
     local skuId = var.skuId  
     local r = var.item_dynamic ~= &quot;1&quot; and ngx.re.match(skuId, &quot;^[0-9]{8}$&quot;)  
     if r then return &quot;1&quot; else return &quot;0&quot; end;  
';  
set_by_lua $to_mvd '  
     local ngx_match = ngx.re.match  
     local var = ngx.var  
     local skuId = var.skuId  
     local r = var.item_dynamic ~= &quot;1&quot; and ngx.re.match(skuId, &quot;^[0-9]{9}$&quot;)  
     if r then return &quot;1&quot; else return &quot;0&quot; end;  
';  
#自营图书  
if ($to_book) {  
    proxy_pass http://127.0.0.1/old_book/$skuId.html;  
}  
#自营音像  
if ($to_mvd) {  
    proxy_pass http://127.0.0.1/old_mvd/$skuId.html;  
}  
#默认  
proxy_pass http://127.0.0.1/proxy/$skuId.html;  
</code></pre></div><h3 id="_4丶rewrite-by-lua"><a href="#_4丶rewrite-by-lua" class="header-anchor">#</a> 4丶rewrite_by_lua</h3> <p>执行内部URL重写或者外部重定向，典型的如伪静态化的URL重写。其默认执行在rewrite处理阶段的最后。</p> <h4 id="_1-1-example-conf配置文件-2"><a href="#_1-1-example-conf配置文件-2" class="header-anchor">#</a> （1.1）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_rewrite_1 {  
    default_type &quot;text/html&quot;;  
    rewrite_by_lua_file /usr/example/lua/test_rewrite_1.lua;  
    echo &quot;no rewrite&quot;;  
}  
</code></pre></div><h4 id="_1-2-test-rewrite-1-lua"><a href="#_1-2-test-rewrite-1-lua" class="header-anchor">#</a> （1.2）test_rewrite_1.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>if ngx.req.get_uri_args()[&quot;jump&quot;] == &quot;1&quot; then  
   return ngx.redirect(&quot;http://www.jd.com?jump=1&quot;, 302)  
end  
</code></pre></div><p>当我们请求http://192.168.1.2/lua_rewrite_1时发现没有跳转，而请求http://192.168.1.2/lua_rewrite_1?jump=1时发现跳转到京东首页了。 此处需要301/302跳转根据自己需求定义。</p> <h4 id="_2-1-example-conf配置文件-2"><a href="#_2-1-example-conf配置文件-2" class="header-anchor">#</a> （2.1）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_rewrite_2 {  
    default_type &quot;text/html&quot;;  
    rewrite_by_lua_file /usr/example/lua/test_rewrite_2.lua;  
    echo &quot;rewrite2 uri : $uri, a : $arg_a&quot;;  
}  
</code></pre></div><h4 id="_2-2-test-rewrite-2-lua"><a href="#_2-2-test-rewrite-2-lua" class="header-anchor">#</a> （2.2）test_rewrite_2.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>if ngx.req.get_uri_args()[&quot;jump&quot;] == &quot;1&quot; then  
   ngx.req.set_uri(&quot;/lua_rewrite_3&quot;, false);  
   ngx.req.set_uri(&quot;/lua_rewrite_4&quot;, false);  
   ngx.req.set_uri_args({a = 1, b = 2});  
end  
</code></pre></div><p><strong>ngx.req.set_uri(uri, false)：</strong></p> <p>可以内部重写uri（可以带参数），等价于 <code>rewrite ^ /lua_rewrite_3</code>；
通过配合if/else可以实现 <code>rewrite^ /lua_rewrite_3 break</code>；这种功能；此处两者都是location内部url重写，不会重新发起新的location匹配；</p> <p><strong>ngx.req.set_uri_args：</strong></p> <p>重写请求参数，可以是字符串(a=1&amp;b=2)也可以是table；</p> <p>访问如http://192.168.1.2/lua_rewrite_2?jump=0时得到响应
rewrite2 uri : /lua_rewrite_2, a :</p> <p>访问如http://192.168.1.2/lua_rewrite_2?jump=1时得到响应
rewrite2 uri : /lua_rewrite_4, a : 1</p> <h4 id="_3-1-example-conf配置文件"><a href="#_3-1-example-conf配置文件" class="header-anchor">#</a> （3.1）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_rewrite_3 {  
    default_type &quot;text/html&quot;;  
    rewrite_by_lua_file /usr/example/lua/test_rewrite_3.lua;  
    echo &quot;rewrite3 uri : $uri&quot;;  
} 
</code></pre></div><h4 id="_3-2-test-rewrite-3-lua"><a href="#_3-2-test-rewrite-3-lua" class="header-anchor">#</a> （3.2）test_rewrite_3.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>if ngx.req.get_uri_args()[&quot;jump&quot;] == &quot;1&quot; then  
   ngx.req.set_uri(&quot;/lua_rewrite_4&quot;, true);  
   ngx.log(ngx.ERR, &quot;=========&quot;)  
   ngx.req.set_uri_args({a = 1, b = 2});  
end 
</code></pre></div><p><strong>ngx.req.set_uri(uri, true)：</strong></p> <p>可以内部重写uri，即会发起新的匹配location请求，等价于 <code>rewrite ^ /lua_rewrite_4 last</code>；
此处看error log是看不到我们记录的log。</p> <p>所以请求如http://192.168.1.2/lua_rewrite_3?jump=1会到新的location中得到响应，此处没有/lua_rewrite_4，所以匹配到/lua请求，得到类似如下的响应</p> <div class="language- extra-class"><pre class="language-text"><code>global variable : 2 ,
shared memory : 1
hello world
</code></pre></div><p>即</p> <div class="language- extra-class"><pre class="language-text"><code>rewrite ^ /lua_rewrite_3; 等价于 ngx.req.set_uri(“/lua_rewrite_3”, false);

rewrite ^ /lua_rewrite_3break; 等价于 ngx.req.set_uri(“/lua_rewrite_3”, false); 加if/else判断/break/return

rewrite ^ /lua_rewrite_4 last; 等价于 ngx.req.set_uri(“/lua_rewrite_4”, true);
</code></pre></div><p>注意，在使用rewrite_by_lua时，开启rewrite_log on;后也看不到相应的rewrite log。</p> <h3 id="_5、access-by-lua"><a href="#_5、access-by-lua" class="header-anchor">#</a> 5、access_by_lua</h3> <p>用于访问控制，比如我们只允许内网ip访问，可以使用如下形式</p> <div class="language- extra-class"><pre class="language-text"><code>allow     127.0.0.1;  
allow     10.0.0.0/8;  
allow     192.168.0.0/16;  
allow     172.16.0.0/12;  
deny      all; 
</code></pre></div><h4 id="_1-1-example-conf配置文件-3"><a href="#_1-1-example-conf配置文件-3" class="header-anchor">#</a> （1.1）example.conf配置文件</h4> <div class="language- extra-class"><pre class="language-text"><code>location /lua_access {  
    default_type &quot;text/html&quot;;  
    access_by_lua_file /usr/example/lua/test_access.lua;  
    echo &quot;access&quot;;  
}  
</code></pre></div><h4 id="_1-2-test-access-lua"><a href="#_1-2-test-access-lua" class="header-anchor">#</a> （1.2）test_access.lua</h4> <div class="language- extra-class"><pre class="language-text"><code>if ngx.req.get_uri_args()[&quot;token&quot;] ~= &quot;123&quot; then  
   return ngx.exit(403)  
end  
</code></pre></div><p>即如果访问如http://192.168.1.2/lua_access?token=234将得到403 Forbidden的响应。这样我们可以根据如cookie/用户token来决定是否有访问权限。</p> <h3 id="_5、content-by-lua"><a href="#_5、content-by-lua" class="header-anchor">#</a> 5、content_by_lua</h3> <p>此指令之前已经用过了，此处就不讲解了。</p></div> <footer class="page-edit"><!----> <!----></footer> <!----> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.2cd84a3f.js" defer></script><script src="/assets/js/2.63c13255.js" defer></script><script src="/assets/js/40.b516ee81.js" defer></script>
  </body>
</html>
